<table id="dgSlab" class="easyui-datagrid"
       toolbar="#toolbarSlab" pagination="true" idfield="id"
       rownumbers="true" fitcolumns="true" singleselect="true">
    <thead>
    <tr>
        <th field="Id" width="5" hidden="true">ID</th>
        <th field="RailWay" width="80" editor="text" sortable="true">线别</th>
        <th field="RunType" width="50" editor="text" sortable="true">行别</th>
        <th field="Mileage" width="65" editor="text" sortable="true">里程</th>
        <th field="StartBoardID" width="65" editor="text" sortable="true">起点板号</th>
        <th field="SupportRailID" width="65" editor="text" sortable="true">承轨台号</th>
        <th field="HurtItem" width="65" editor="text" sortable="true">伤损项目</th>
        <th field="HurtPosition" width="65" editor="text" sortable="true">伤损位置</th>
        <th field="HurtStyle" width="65" editor="text" sortable="true">伤损形式</th>
        <th field="Length" width="50" editor="text" sortable="true">长</th>
        <th field="Width" width="50" editor="text" sortable="true">宽</th>
        <th field="Height" width="50" editor="text" sortable="true">高</th>
        <th field="HurtLevel" width="65" editor="text" sortable="true">伤损等级</th>
        <th field="CheckDate" width="68" editor="text" formatter="DateFormatter" sortable="true">检测日期</th>
        <th field="Checker" width="80" editor="text" sortable="true">检测人</th>
        <th field="Movie" width="65" editor="text" sortable="true">影像资料</th>
        <th field="TakeMeasures" width="65" editor="text" sortable="true">采取措施</th>
        <th field="LogoutDate" width="68" editor="text" formatter="DateFormatter" sortable="true">销号日期</th>
        <th field="LogoutMan" width="80" editor="text" sortable="true">销号人</th>
        <th field="Remark" width="80" editor="text" sortable="true">备注</th>
    </tr>
    </thead>
</table>

<style type="text/css">
    #fm {
        margin: 0;
        padding: 10px 30px;
    }

</style>



<div id="toolbarSlab" style="text-align: right">

    <a class="easyui-linkbutton" id="btSearchSlab" iconcls="icon-search" plain="true">查询</a>
    <br/>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true" onclick="addSlab()">添加</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true" onclick="editSlab()">修改</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true" onclick="deleteSlab()">删除</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-undo" plain="true" onclick="importData();">导入数据</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-redo" plain="true" onclick="bsuExportCsv2();">导出数据</a>
</div>


<div id="dlg" class="easyui-dialog" style="width: 500px; height: 480px; padding: 10px 20px"
     closed="true" buttons="#dlg-buttons">

    <form id="fm" method="post" novalidate>
        <input type="hidden" name="Id" id="pId"/>

        <div class="fitem">
            <label>线别:</label>
            <select class="easyui-combobox" name="RailWay" id="pRailWay" style="width: 204px;">
                <option value="京广高铁" selected>京广高铁</option>
                <option value="京沪高铁">京沪高铁</option>
                <option value="京津城际">京津城际</option>
                <option value="津秦高铁">津秦高铁</option>
            </select>
        </div>
        <div class="fitem">
            <label>行别:</label>
            <select class="easyui-combobox" name="RunType" id="pRunType" style="width: 204px;">
                <option value="上行" selected >上行</option>
                <option value="下行">下行</option>
            </select>
        </div>
        <div class="fitem">
            <label>里程:</label>
            <input name="Mileage" id="pMileage" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>起点板号:</label>
            <input name="StartBoardID" id="pStartBordID" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>承轨台号:</label>
            <input name="SupportRailID" id="pSupportRailID" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>伤损项目:</label>
            <select class="easyui-combobox" id="pHurtItem" name="HurtItem" style="width: 204px;">
                <option value="轨道板" selected>轨道板</option>
                <option value="底座板（支撑层）">底座板（支撑层）</option>
                <option value="CA砂浆层">CA砂浆层</option>
                <option value="板间接缝">板间接缝</option>
                <option value="侧向挡块">侧向挡块</option>
                <option value="挤塑板">挤塑板</option>
            </select>
        </div>
        <div class="fitem">
            <label>伤损位置:</label>

            <select class="easyui-combobox" name="HurtPosition" id="pHurtPosition" style="width: 204px;">
                <option value="灌浆孔" selected>灌浆孔</option>
                <option value="剪力筋">剪力筋</option>
            </select>
        </div>
        <div class="fitem">
            <label>伤损形式:</label>
            <select class="easyui-combobox" name="HurtStyle" id="pHurtStyle" style="width: 204px;">
                <option value="裂纹" selected>裂纹</option>
                <option value="掉块">掉块</option>
                <option value="其他">其他</option>
                <option value="失效">失效</option>
                <option value="离缝">离缝</option>
                <option value="凸起">凸起</option>
            </select>
        </div>
        <div class="fitem">
            <label>长:</label>
            <input name="Length" id="pLength" class="easyui-numberbox" precision="2">
        </div>
        <div class="fitem">
            <label>宽:</label>
            <input name="Width" id="pWidth" class="easyui-numberbox" precision="2">
        </div>
        <div class="fitem">
            <label>高:</label>
            <input name="Height" id="pHeight" class="easyui-numberbox" precision="2">
        </div>
        <div class="fitem">
            <label>伤损等级:</label>
            <input name="HurtLevel" id="pHurtLevel" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>检测日期:</label>
            <input name="CheckDate" id="pCheckDate" class="easyui-datebox" style="width: 204px;">
        </div>
        <div class="fitem">
            <label>检测人:</label>
            <input name="Checker" id="pChecker" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>影像资料:</label>
            <input name="Movie" id="pMovie" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>采取措施:</label>
            <input name="TakeMeasures" id="pTakeMeasures" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>销号日期:</label>
            <input name="LogoutDate" id="pLogoutDate" class="easyui-datebox" style="width: 204px;">
        </div>
        <div class="fitem">
            <label>销号人:</label>
            <input name="LogoutMan" id="pLogoutMan" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>备注:</label>
            <input name="Remark" id="pRemark" class="easyui-textbox">
        </div>
    </form>
</div>

<div class="easyui-dialog" id="divUpdate" title="上传文件" buttons="#divUpdate-buttons" closed="true" style="width: 400px; padding: 30px 70px 50px 70px">
    <form id="filePost" action="/slab/Upload" method="post" enctype="multipart/form-data">
        <div>数据文件:</div>

        <input type="file" name="fileData"/>


    </form>
</div>

<div class="easyui-dialog" id="divSearch" title="查询" buttons="#divSearch-buttons" closed="true" style="width: 500px; padding: 30px 70px 50px 70px">
    <div class="fitem">
        <label>线别:</label>
        <select class="easyui-combobox" name="RailWay" id="aRailWay" style="width: 204px;">
            <option value="" selected>全部</option>
            <option value="京广高铁" >京广高铁</option>
            <option value="京沪高铁">京沪高铁</option>
            <option value="京津城际">京津城际</option>
            <option value="津秦高铁">津秦高铁</option>
        </select>
    </div>
    <div class="fitem">
        <label>行别:</label>
        <select class="easyui-combobox" name="RunType" id="aRunType" style="width: 204px;">
            <option value="" selected>全部</option>
            <option value="上行">上行</option>
            <option value="下行">下行</option>
        </select>
    </div>
    <div class="fitem">
        <label>起始里程:</label>
        <input name="Mileage" id="aMileage" class="easyui-textbox">
    </div>
    <div class="fitem">
        <label>终止里程:</label>
        <input name="StartBoardID" id="aMileage2" class="easyui-textbox">
    </div>
    <div class="fitem">
        <label>伤损项目:</label>
        <select class="easyui-combobox" id="aHurtItem" name="HurtItem" style="width: 204px;">
            <option value="" selected >全部</option>
            <option value="轨道板" >轨道板</option>
            <option value="底座板（支撑层）">底座板（支撑层）</option>
            <option value="CA砂浆层">CA砂浆层</option>
            <option value="板间接缝">板间接缝</option>
            <option value="侧向挡块">侧向挡块</option>
            <option value="挤塑板">挤塑板</option>
        </select>
    </div>
    <div class="fitem">
        <label>伤损位置:</label>

        <select class="easyui-combobox" name="HurtPosition" id="aHurtPosition" style="width: 204px;">
            <option value="" selected>全部</option>
            <option value="灌浆孔" >灌浆孔</option>
            <option value="剪力筋">剪力筋</option>
        </select>
    </div>
    <div class="fitem">
        <label>伤损形式:</label>
        <select class="easyui-combobox" name="HurtStyle" id="aHurtStyle" style="width: 204px;">
            <option value="" selected>全部</option>
            <option value="裂纹">裂纹</option>
            <option value="掉块">掉块</option>
            <option value="其他">其他</option>
            <option value="失效">失效</option>
            <option value="离缝">离缝</option>
            <option value="凸起">凸起</option>
        </select>
    </div>
    <div class="fitem">
        <label>伤损等级:</label>
        <input name="HurtLevel" id="aHurtLevel" class="easyui-textbox">
    </div>
    <div class="fitem">
        <label>起始检测日期:</label>
        <input name="CheckDate" id="aCheckDate" class="easyui-datebox" style="width: 204px;">
    </div>
    <div class="fitem">
        <label>终止检测日期:</label>
        <input name="CheckDate" id="aCheckDate2" class="easyui-datebox" style="width: 204px;">
    </div>
    <div class="fitem">
        <label>起始销号日期:</label>
        <input name="CheckDate" id="aLogoutDate" class="easyui-datebox" style="width: 204px;">
    </div>
    <div class="fitem">
        <label>终止销号日期:</label>
        <input name="CheckDate" id="aLogoutDate2" class="easyui-datebox" style="width: 204px;">
    </div>
</div>

<div id="divUpdate-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" onclick="ImpData()" style="width:90px">上传</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="javascript: $('#divUpdate').dialog('close')" style="width:90px">取消</a>
</div>
<div id="dlg-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" onclick="saveSlab()" style="width: 90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')" style="width: 90px">取消</a>
</div>

<div id="divSearch-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" onclick="SearchData()" style="width:90px">确定</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="javascript: $('#divSearch').dialog('close')" style="width:90px">取消</a>
</div>
<script type="text/javascript">
    $(function() {


        $('#dgSlab').datagrid({
            fit: true,
            method: 'get',
            pageSize:15,
            pageList:[15,30,50],
            singleSelect: true,
            url: '/api/Slab'
        });

        
        $("#btSearchSlab").click(function () {
            $('#divSearch').dialog('open');
        });

    });

    function SearchData() {

        var railway = $("#aRailWay").combobox('getValue');
        var runtype = $("#aRunType").combobox('getValue');
        var m = $("#aMileage").val();
        var m2 = $("#aMileage2").val();
        var hurtItem = $('#aHurtItem').combobox('getValue');
        var hurtPosition = $('#aHurtPosition').combobox('getValue');
        var hurtStyle = $('#aHurtStyle').combobox('getValue');
        var hurtLevel = $("#aHurtLevel").val();
        var ctime = $('#aCheckDate').datebox('getValue');
        var ctime2 = $("#aCheckDate2").datebox('getValue');

        var ltime = $('#aLogoutDate').datebox('getValue');
        var ltime2 = $("#aLogoutDate2").datebox('getValue');



        $('#dgSlab').datagrid({
            queryParams: {
                Railway: railway,
                Runtype: runtype,
                Mileage: m,
                Mileage2: m2,
                HurtItem: hurtItem,
                HurtPosition: hurtPosition,
                HurtStyle: hurtStyle,
                HurtLevel: hurtLevel,
                CheckDate: ctime,
                CheckDate2: ctime2,
                LogoutDate: ltime,
                LogoutDate2: ltime2
            }
        });

       // $('#dgSlab').datagrid('reload');
        $('#divSearch').dialog('close');
    };

    var url;

    function addSlab() {
        $('#dlg').dialog('open').dialog('setTitle', '添加轨道板问题');
        $('#fm').form('clear');
        url = '/api/Slab/Add';
    }

    function editSlab() {
        var row = $('#dgSlab').datagrid('getSelected');
        if (row) {
            $('#dlg').dialog('open').dialog('setTitle', '编辑轨道板问题');
            $('#fm').form('load', row);
            url = '/api/Slab/edit';

        }
    }

    function getSlab() {
        var data = {
            RailWay: $("#pRailWay").combobox('getValue'),
            Id: $("#pId").val(),
            RunType: $("#pRunType").combobox('getValue'),
            Mileage: $("#pMileage").val(),
            StartBoardID: $("#pStartBoardID").val(),
            SupportRailID: $("#pSupportRailID").val(),
            HurtItem: $("#pHurtItem").combobox('getValue'),
            HurtPosition: $("#pHurtPosition").combobox('getValue'),
            HurtStyle: $("#pHurtStyle").combobox('getValue'),
            Length: $("#pLength").val(),
            Width: $("#pWidth").val(),
            Height: $("#pHeight").val(),
            HurtLevel: $('#pHurtLevel').val(),
            CheckDate: $('#pCheckDate').val(),
            Checker: $('#pChecker').val(),
            Movie: $('#pMovie').val(),
            TakeMeasures: $('#pTakeMeasures').val(),
            LogoutDate: $('#pLogoutDate').val(),
            LogoutMan: $('#pLogoutMan').val(),

            Remark: $("#pRemark").val()
        }

        return data;
    }

    function saveSlab() {
        postData(url, getSlab(), function (result) {
            if (result.Success) {
                $('#dlg').dialog('close'); // close the dialog
                $('#dgSlab').datagrid('reload'); // reload the user data
                $.messager.show({
                    title: '成功',
                    msg: '保存成功！'
                });
            } else {
                $.messager.show({
                    title: '错误',
                    msg: result.Msg
                });
            }
        });
    }

    function deleteSlab() {
        var row = $('#dgSlab').datagrid('getSelected');
        if (row) {
            $.messager.confirm('删除', '确定要删除选中的数据吗?', function(r) {
                if (r) {
                    var rr = [];
                    rr.push(row.Id);
                    postData('/Slab/delete', rr, function (result) {
                       
                        if (result.Success) {
                            $('#dgSlab').datagrid('reload'); // reload the user data
                        } else {
                            $.messager.show({
                                title: '错误',
                                msg: "删除失败"
                            });
                        }
                    });

                }
            });
        }
    }

    function importData() {
        $('#divUpdate').dialog('open');

    }

    function ImpData() {
        $('#filePost').form('submit', {
            dataType: 'json',
            onSubmit: function () {
                return $(this).form('validate');
            },
            success: function (result) {
                if (result=="") {
                    $('#divUpdate').dialog('close'); // close the dialog
                    $('#dgSlab').datagrid('reload'); // reload the user data

                } else {
                    $.messager.show({
                        title: '错误',
                        msg: result
                    });
                }
            }
        });
    }

    function bsuExportCsv2() {
        var url = "../api/Slabxls";

        if ($('#downloadxls').length <= 0)
            $('body').append("<iframe id=\"downloadxls\" style=\"display:none\"></iframe>");
        $('#downloadxls').attr('src', url);
    }


</script>
